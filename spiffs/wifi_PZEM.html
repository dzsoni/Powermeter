<!DOCTYPE html>

<html>
  <head>
    <title>PZEM Device Search</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="Cache-Control" content="no-cache"/>
    <meta http-equiv="Pragma" content="no-cache" />
    <link href="pure-all.min.css" rel="stylesheet" type="text/css" />
    <script>
      var hardwareSerials = [];
      var isScanning = false;
      var knownPzems = {}; // Store known PZEM devices from pzem_address.json

      // Clear all items from value field
      function clearValueField() {
        document.getElementById("value-field").innerHTML = "";
      }

      // Show scanning status message
      function showScanningStatus(message) {
        var statusDiv = document.getElementById("status-message");
        if (statusDiv) {
          statusDiv.textContent = message;
        }
        console.log("Status: " + message);
      }

      // Update scan progress
      function updateScanProgress(serialName, currentAddress, maxAddress, rxPin, txPin) {
        var percent = Math.floor((currentAddress / maxAddress) * 100);
        var pinInfo = (rxPin !== undefined && txPin !== undefined) ? " [rx" + rxPin + ",tx" + txPin + "]" : "";
        showScanningStatus("Scanning " + serialName + pinInfo + ": " + percent + "% (" + currentAddress + "/" + maxAddress + ")");
      }

      // Scan all hardware serials for PZEM devices
      function scanAllSerials(serials) {
        var currentSerial = 0;
        
        function scanNextSerial() {
          if (!isScanning) return;
          if (currentSerial >= serials.length) {
            isScanning = false;
            var deviceCount = document.getElementById("value-field").children.length;
            showScanningStatus("Scan complete! Found " + deviceCount + " PZEM device(s).");
            document.getElementById("btnrescan").disabled = false;
            return;
          }
          
          var serial = serials[currentSerial];
          scanPZEMAddresses(serial, function() {
            currentSerial++;
            scanNextSerial();
          });
        }
        
        scanNextSerial();
      }

      // Scan PZEM addresses 1-248 for a specific hardware serial
      function scanPZEMAddresses(serial, callback) {
        var address = 1;
        var maxAddress = 248;
        
        function scanNextAddress() {
          if (!isScanning) return;
          if (address > maxAddress) {
            callback();
            return;
          }
          
          updateScanProgress(serial.serialName || serial, address, maxAddress, serial.rxPin, serial.txPin);
          
          var xhttp = new XMLHttpRequest();
          xhttp.timeout = 5000; // 5 second timeout
          
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
              if (this.status == 200) {
                try {
                  var response = this.responseText.trim();
                  // Handle both boolean and JSON responses
                  var canRead = false;
                  if (response === "true" || response === "1") {
                    canRead = true;
                  } else {
                    try {
                      var jsonResponse = JSON.parse(response);
                      canRead = jsonResponse === true || jsonResponse.canRead === true;
                    } catch (e) {
                      canRead = false;
                    }
                  }
                  
                  if (canRead) {
                    // Look up device name from known PZEMs
                    var deviceName = "";
                    for (var idx in knownPzems) {
                      var pzem = knownPzems[idx];
                      // Match by serial name, RX pin, TX pin, and current address
                      if (pzem.ser == serial.serialName &&
                          parseInt(pzem.rx) == serial.rxPin &&
                          parseInt(pzem.tx) == serial.txPin &&
                          (parseInt(pzem.addr) == address || parseInt(pzem.newaddr) == address)) {
                        deviceName = pzem.name || "";
                        console.log("Found known PZEM:", deviceName, "for", serial.serialName, address);
                        break;
                      }
                    }
                    appenditemtovf(serial.serialName || serial, address, "", serial.rxPin, serial.txPin, deviceName);
                  }
                } catch (e) {
                  console.error("Error parsing response for address " + address + ": " + e);
                }
              }
              address++;
              // Add delay to prevent overwhelming the server
              setTimeout(scanNextAddress, 50);
            }
          };
          
          xhttp.ontimeout = function() {
            console.warn("Timeout checking address " + address);
            address++;
            setTimeout(scanNextAddress, 50);
          };
          
          xhttp.onerror = function() {
            console.error("Error checking address " + address);
            address++;
            setTimeout(scanNextAddress, 50);
          };
          
          var url = "/canread?address=" + address;
          if (serial.serialName) {
            url += "&serial=" + encodeURIComponent(serial.serialName);
            url += "&rx=" + serial.rxPin;
            url += "&tx=" + serial.txPin;
          }
          xhttp.open("GET", url, true);
          xhttp.send();
        }
        
        scanNextAddress();
      }

      // Load known PZEM devices from pzem_address.json
      function loadKnownPzems(callback) {
        var xhttp = new XMLHttpRequest();
        xhttp.timeout = 5000;
        
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4) {
            if (this.status == 200) {
              try {
                var obj = JSON.parse(this.responseText);
                var keys = Object.keys(obj);
                
                // Parse the JSON to create a lookup map
                // Key format: "serialName:rxPin:txPin:address" -> deviceName
                for (var i = 0; i < keys.length; i++) {
                  var key = keys[i];
                  var parts = key.split(":");
                  if (parts.length >= 2) {
                    var index = parts[0];
                    var field = parts[1];
                    
                    if (!knownPzems[index]) {
                      knownPzems[index] = {};
                    }
                    knownPzems[index][field] = obj[key];
                  }
                }
                console.log("Loaded known PZEMs:", knownPzems);
              } catch (e) {
                console.log("No existing PZEM data or parse error:", e);
              }
            }
            callback();
          }
        };
        
        xhttp.ontimeout = function() {
          console.log("Timeout loading known PZEMs");
          callback();
        };
        
        xhttp.onerror = function() {
          console.log("Error loading known PZEMs");
          callback();
        };
        
        xhttp.open("GET", "/pzem_address.json", true);
        xhttp.send();
      }

      // Main function to start fetching hardware serials and initiate scan
      function fillValueField() {
        if (isScanning) {
          showScanningStatus("Scan already in progress...");
          return;
        }
        
        isScanning = true;
        clearValueField();
        showScanningStatus("Loading known PZEM devices...");
        document.getElementById("btnrescan").disabled = true;
        
        // First load known PZEMs, then fetch hardware serials
        loadKnownPzems(function() {
          showScanningStatus("Fetching hardware serials...");
          
          var xhttp = new XMLHttpRequest();
          xhttp.timeout = 10000; // 10 second timeout
          
          xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
              if (this.status == 200) {
                try {
                  hardwareSerials = JSON.parse(this.responseText);
                  if (hardwareSerials.length === 0) {
                    showScanningStatus("No hardware serials configured!");
                    isScanning = false;
                    document.getElementById("btnrescan").disabled = false;
                    return;
                  }
                  showScanningStatus("Found " + hardwareSerials.length + " hardware serial(s). Starting scan...");
                  scanAllSerials(hardwareSerials);
                } catch (e) {
                  showScanningStatus("Error parsing hardware serial data: " + e.message);
                  isScanning = false;
                  document.getElementById("btnrescan").disabled = false;
                }
              } else {
                showScanningStatus("Error fetching hardware serials (Status: " + this.status + ")");
                isScanning = false;
                document.getElementById("btnrescan").disabled = false;
              }
            }
          };
          
          xhttp.ontimeout = function() {
            showScanningStatus("Timeout fetching hardware serials");
            isScanning = false;
            document.getElementById("btnrescan").disabled = false;
          };
          
          xhttp.onerror = function() {
            showScanningStatus("Network error fetching hardware serials");
            isScanning = false;
            document.getElementById("btnrescan").disabled = false;
          };
          
          xhttp.open("GET", "/getusedserials", true);
          xhttp.send();
        });
      }

      // Append a PZEM device item to the value field
      function appenditemtovf(serialName, address, newaddress, rxPin, txPin, deviceName) {
        let i = document.getElementById("value-field").children.length;
        let div = document.createElement("div");
        div.setAttribute("class", "item");
        div.setAttribute("id", "i" + i);

        // Hidden field for serial name
        let inpSerial = document.createElement("input");
        inpSerial.setAttribute("type", "hidden");
        inpSerial.setAttribute("id", "s" + i);
        inpSerial.setAttribute("name", "s" + i);
        inpSerial.setAttribute("value", serialName);
        div.appendChild(inpSerial);

        // Hidden field for address
        let inpAddr = document.createElement("input");
        inpAddr.setAttribute("type", "hidden");
        inpAddr.setAttribute("id", "a" + i);
        inpAddr.setAttribute("name", "a" + i);
        inpAddr.setAttribute("value", address);
        div.appendChild(inpAddr);

        // Hidden field for RX pin
        let inpRx = document.createElement("input");
        inpRx.setAttribute("type", "hidden");
        inpRx.setAttribute("id", "rx" + i);
        inpRx.setAttribute("name", "rx" + i);
        inpRx.setAttribute("value", rxPin || "");
        div.appendChild(inpRx);

        // Hidden field for TX pin
        let inpTx = document.createElement("input");
        inpTx.setAttribute("type", "hidden");
        inpTx.setAttribute("id", "tx" + i);
        inpTx.setAttribute("name", "tx" + i);
        inpTx.setAttribute("value", txPin || "");
        div.appendChild(inpTx);

        // Status indicator
        let roitStatus = document.createElement("div");
        roitStatus.setAttribute("class", "rowitem");
        let statusDiv = document.createElement("div");
        statusDiv.setAttribute("id", "status" + i);
        statusDiv.innerHTML = '&#x1F7E2;'; // Green circle
        roitStatus.appendChild(statusDiv);
        div.appendChild(roitStatus);

        // Serial Name Label
        let roitSerial = document.createElement("div");
        roitSerial.setAttribute("class", "rowitem");
        let serialLabel = document.createElement("label");
        serialLabel.textContent = serialName + (rxPin ? " [rx" + rxPin + ",tx" + txPin + "]" : "");
        roitSerial.appendChild(serialLabel);
        div.appendChild(roitSerial);

        // Address Label
        let roitAddr = document.createElement("div");
        roitAddr.setAttribute("class", "rowitem");
        let addrLabel = document.createElement("label");
        addrLabel.setAttribute("for", "n" + i);
        addrLabel.textContent = "Addr: " + address;
        roitAddr.appendChild(addrLabel);
        div.appendChild(roitAddr);

        // Device Name Input Field
        let roitDevName = document.createElement("div");
        roitDevName.setAttribute("class", "rowitem");
        let devNameInput = document.createElement("input");
        devNameInput.setAttribute("type", "text");
        devNameInput.setAttribute("id", "name" + i);
        devNameInput.setAttribute("name", "name" + i);
        devNameInput.setAttribute("maxlength", "32");
        devNameInput.setAttribute("size", "12");
        devNameInput.setAttribute("value", deviceName || "");
        devNameInput.setAttribute("placeholder", "Device name");
        roitDevName.appendChild(devNameInput);
        div.appendChild(roitDevName);

        // New Address Input Field
        let roitNewAddr = document.createElement("div");
        roitNewAddr.setAttribute("class", "rowitem");
        let newAddrInput = document.createElement("input");
        newAddrInput.setAttribute("type", "text");
        newAddrInput.setAttribute("id", "n" + i);
        newAddrInput.setAttribute("name", "n" + i);
        newAddrInput.setAttribute("maxlength", "3");
        newAddrInput.setAttribute("size", "12");
        newAddrInput.setAttribute("value", newaddress);
        newAddrInput.setAttribute("placeholder", "New addr");
        roitNewAddr.appendChild(newAddrInput);
        div.appendChild(roitNewAddr);

        document.getElementById("value-field").appendChild(div);
      }

      // Rescan button click handler
      function rescanhButtonClick() {
        if (isScanning) {
          showScanningStatus("Scan already in progress...");
          return;
        }
        clearValueField();
        fillValueField();
      }

      // Stop button click handler
      function stopScan() {
        if (isScanning) {
          isScanning = false;
          showScanningStatus("Scan stopped by user.");
          document.getElementById("btnrescan").disabled = false;
        }
      }

      // Save button click handler
      saveAddresses = function saveAddresses() {
        var form = document.querySelector('form');
        var formData = new FormData(form);
        
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
          if (this.readyState == 4) {
            if (this.status == 200) {
              showScanningStatus("Saved.");
            } else {
              showScanningStatus("Error saving: " + this.status);
            }
          }
        };
        xhttp.open("POST", "/savePZEMaddress/", true);
        xhttp.send(formData);
      }

      // Initialize on page load
      document.addEventListener("DOMContentLoaded", function () {
        
        fillValueField();
      });
    </script>
  </head>

  <body>
    <div class="header">
      <div class="home"><img  alt = "Home"  src = "home.svg"  onClick="location.href='wifi_index.html'"/></div>
    <h1>PZEM Search</h1>
    </div>

    

    <form action="/savePZEMaddress/" method="POST">

       <div id="containervf">
         <div id="value-field" class="value-field"></div>
       </div>
      <input type="button" id="btnrescan" value="Scan" onclick="rescanhButtonClick()"/>
      <input type="button" id="btnstop" value="Stop" onclick="stopScan()"/>
      <input type="button" value="Save" onclick="saveAddresses()" />
    </form>
    <div id="scan-status" style="padding: 10px; margin: 10px 0; border: 1px solid #ddd; background-color: #f9f9f9;">
      <div id="status-message" style="font-weight: bold;">Ready to scan...</div>
    </div>
  </body>
</html>
